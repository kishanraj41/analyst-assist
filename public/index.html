<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AnalystAssist - Cyberpunk Dashboard</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            'cyberpunk-bg': '#0A0A23',
            'cyberpunk-light-bg': '#2A2A4A',
            'cyberpunk-neon-pink': '#FF007A',
            'cyberpunk-neon-cyan': '#00D4FF',
            'cyberpunk-neon-purple': '#9D00FF',
            'cyberpunk-accent': '#FFD700',
            'cyberpunk-light': '#E6E6FA',
          },
          fontFamily: {
            cyberpunk: ['"Orbitron"', 'sans-serif'],
          },
          boxShadow: {
            'neon-glow': '0 0 10px #FF007A, 0 0 20px #00D4FF',
          },
        },
      },
    };
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body className="bg-cyberpunk-bg dark:bg-cyberpunk-light-bg min-h-screen font-cyberpunk">
  <div id="root"></div>
  <script type="text/babel" data-presets="react">
    const { useState, useEffect, Component } = React;

    class ErrorBoundary extends Component {
      state = { hasError: false, error: null };
      static getDerivedStateFromError(error) {
        return { hasError: true, error };
      }
      render() {
        if (this.state.hasError) {
          return (
            <div className="text-cyberpunk-neon-pink text-center p-4">
              <h2 className="text-2xl font-bold">System Failure</h2>
              <p>{this.state.error?.message || 'Unknown error'}</p>
              <p>Check console logs for debug info.</p>
            </div>
          );
        }
        return this.props.children;
      }
    }

    function ThemeToggle() {
      const [darkMode, setDarkMode] = useState(() => {
        const saved = localStorage.getItem('theme');
        if (saved) return saved === 'dark';
        return window.matchMedia('(prefers-color-scheme: dark)').matches;
      });

      useEffect(() => {
        console.log('ThemeToggle: darkMode =', darkMode);
        if (darkMode) {
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        } else {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('theme', 'light');
        }
      }, [darkMode]);

      return (
        <button
          onClick={() => {
            console.log('Toggling theme to', !darkMode ? 'dark' : 'light');
            setDarkMode(!darkMode);
          }}
          className="p-2 rounded-full bg-cyberpunk-neon-purple text-cyberpunk-light hover:shadow-neon-glow transition"
          title={darkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'}
        >
          {darkMode ? 'üåû' : 'üåå'}
        </button>
      );
    }

    function Sidebar({ onQuerySelect, onUploadSelect }) {
      return (
        <div className="w-64 bg-cyberpunk-bg dark:bg-cyberpunk-light-bg border-r border-cyberpunk-neon-cyan h-screen p-4">
          <h1 className="text-2xl font-bold text-cyberpunk-neon-pink dark:text-cyberpunk-neon-pink mb-6">
            AnalystAssist
          </h1>
          <nav>
            <button
              onClick={onQuerySelect}
              className="w-full text-left p-2 mb-2 rounded text-cyberpunk-neon-cyan dark:text-cyberpunk-neon-cyan hover:bg-cyberpunk-neon-purple hover:text-cyberpunk-light dark:hover:text-cyberpunk-light transition"
            >
              üîç Questions
            </button>
            <button
              onClick={onUploadSelect}
              className="w-full text-left p-2 mb-2 rounded text-cyberpunk-neon-cyan dark:text-cyberpunk-neon-cyan hover:bg-cyberpunk-neon-purple hover:text-cyberpunk-light dark:hover:text-cyberpunk-light transition"
            >
              üì§ Upload Data
            </button>
          </nav>
        </div>
      );
    }

    function AnalystQueryInput({ onSubmit }) {
      const [question, setQuestion] = useState('');
      const handleSubmit = (e) => {
        e.preventDefault();
        if (question.trim()) {
          onSubmit(question, false);
          setQuestion('');
        }
      };
      return (
        <div className="p-4 bg-cyberpunk-bg dark:bg-cyberpunk-light-bg border border-cyberpunk-neon-pink rounded-lg shadow-neon-glow">
          <h2 className="text-lg font-semibold text-cyberpunk-neon-cyan dark:text-cyberpunk-neon-cyan mb-2">
            Ask
          </h2>
          <form onSubmit={handleSubmit}>
            <input
              type="text"
              value={question}
              onChange={(e) => setQuestion(e.target.value)}
              placeholder="E.g., How to optimize a SQL query?"
              className="w-full p-2 border border-cyberpunk-neon-cyan rounded mb-2 bg-cyberpunk-bg dark:bg-cyberpunk-light-bg text-cyberpunk-light dark:text-cyberpunk-light focus:outline-none focus:ring-2 focus:ring-cyberpunk-neon-pink"
            />
            <button
              type="submit"
              className="w-full bg-cyberpunk-neon-purple text-cyberpunk-light dark:text-cyberpunk-light p-2 rounded hover:bg-opacity-80 hover:shadow-neon-glow transition"
            >
              Execute
            </button>
          </form>
        </div>
      );
    }

    function DataUpload({ onSubmit }) {
      const [file, setFile] = useState(null);
      const handleSubmit = (e) => {
        e.preventDefault();
        if (file) {
          onSubmit(file, false);
          setFile(null);
          e.target.reset();
        }
      };
      return (
        <div className="p-4 bg-cyberpunk-bg dark:bg-cyberpunk-light-bg border border-cyberpunk-neon-pink rounded-lg shadow-neon-glow">
          <h2 className="text-lg font-semibold text-cyberpunk-neon-cyan dark:text-cyberpunk-neon-cyan mb-2">
            Upload Data (CSV)
          </h2>
          <form onSubmit={handleSubmit}>
            <input
              type="file"
              accept=".csv"
              onChange={(e) => setFile(e.target.files[0])}
              className="w-full p-2 border border-cyberpunk-neon-cyan rounded mb-2 bg-cyberpunk-bg dark:bg-cyberpunk-light-bg text-cyberpunk-light dark:text-cyberpunk-light"
            />
            <button
              type="submit"
              className="w-full bg-cyberpunk-neon-purple text-cyberpunk-light dark:text-cyberpunk-light p-2 rounded hover:bg-opacity-80 hover:shadow-neon-glow transition"
            >
              How can we analyze this Data?
            </button>
          </form>
        </div>
      );
    }

    function ResultDisplay({ result, loading, error, onFollowUp }) {
      const [followUp, setFollowUp] = useState('');

      const handleFollowUpSubmit = (e) => {
        e.preventDefault();
        if (followUp.trim()) {
          console.log('Submitting follow-up:', followUp);
          onFollowUp(followUp, true);
          setFollowUp('');
        } else {
          console.log('Follow-up empty, not submitting');
        }
      };

      const handleInputChange = (e) => {
        console.log('Follow-up input changed:', e.target.value);
        setFollowUp(e.target.value);
      };

      if (loading) return <div className="text-center text-cyberpunk-neon-cyan dark:text-cyberpunk-neon-cyan p-4">Processing...</div>;
      if (error) return <div className="text-cyberpunk-neon-pink dark:text-cyberpunk-neon-pink text-center p-4">{error}</div>;

      return (
        <div className="p-4 bg-cyberpunk-bg dark:bg-cyberpunk-light-bg border border-cyberpunk-neon-pink rounded-lg shadow-neon-glow">
          {!result ? (
            <p className="text-center text-cyberpunk-light dark:text-cyberpunk-light">
              Initiate a query or upload a CSV to begin analysis.
            </p>
          ) : result.answer ? (
            <>
              <h2 className="text-xl font-semibold text-cyberpunk-neon-cyan dark:text-cyberpunk-neon-cyan mb-2">Results:</h2>
              <p className="text-cyberpunk-light dark:text-cyberpunk-light">{result.answer || 'No result provided'}</p>
            </>
          ) : (
            <>
              <h2 className="text-xl font-semibold text-cyberpunk-neon-cyan dark:text-cyberpunk-neon-cyan mb-2">Analysis Approaches:</h2>
              {result.approaches?.length ? (
                result.approaches.map((approach, index) => (
                  <div key={index} className="mb-4 p-4 bg-cyberpunk-bg dark:bg-cyberpunk-light-bg border border-cyberpunk-neon-cyan rounded">
                    <h3 className="text-lg font-semibold text-cyberpunk-neon-pink dark:text-cyberpunk-neon-pink">{approach.title || 'Untitled Approach'}</h3>
                    <p className="mt-2 text-cyberpunk-light dark:text-cyberpunk-light">{approach.description || 'No description provided'}</p>
                    <p className="mt-1 text-cyberpunk-light dark:text-cyberpunk-light">
                      <strong>Tools:</strong>{' '}
                      {approach.tools?.length ? approach.tools.join(', ') : 'None specified'}
                    </p>
                  </div>
                ))
              ) : (
                <p className="text-cyberpunk-light dark:text-cyberpunk-light">No approaches available</p>
              )}
            </>
          )}
          {result && (
            <>
              <h3 className="text-lg font-semibold text-cyberpunk-neon-cyan dark:text-cyberpunk-neon-cyan mt-4">Reasoning:</h3>
              <ol className="list-decimal pl-5 mt-2 text-cyberpunk-light dark:text-cyberpunk-light">
                {result.reasoning?.length ? (
                  result.reasoning.map((step, index) => (
                    <li key={index}>{step}</li>
                  ))
                ) : (
                  <li>No reasoning provided</li>
                )}
              </ol>
              <h3 className="text-lg font-semibold text-cyberpunk-neon-cyan dark:text-cyberpunk-neon-cyan mt-4">Data Sources:</h3>
              <ul className="list-disc pl-5 mt-2 text-cyberpunk-light dark:text-cyberpunk-light">
                {result.citations?.length ? (
                  result.citations.map((citation, index) => (
                    <li key={index}>
                      [{index + 1}] {typeof citation === 'string' ? citation : `Source ${citation}`}
                    </li>
                  ))
                ) : (
                  <li>No sources provided</li>
                )}
              </ul>
              <div className="mt-4">
                <h3 className="text-lg font-semibold text-cyberpunk-neon-cyan dark:text-cyberpunk-neon-cyan">Follow-up Questions</h3>
                <form onSubmit={handleFollowUpSubmit} className="mt-2">
                  <input
                    type="text"
                    value={followUp}
                    onChange={handleInputChange}
                    placeholder="Ask a follow-up question..."
                    className="w-full p-2 border border-cyberpunk-neon-cyan rounded mb-2 bg-cyberpunk-bg dark:bg-cyberpunk-light-bg text-cyberpunk-light dark:text-cyberpunk-light focus:outline-none focus:ring-2 focus:ring-cyberpunk-neon-pink"
                    autoFocus
                    onFocus={() => console.log('Follow-up input focused')}
                  />
                  <button
                    type="submit"
                    className="w-full bg-cyberpunk-neon-purple text-cyberpunk-light dark:text-cyberpunk-light p-2 rounded hover:bg-opacity-80 hover:shadow-neon-glow transition"
                  >
                    Submit Follow-Up
                  </button>
                </form>
              </div>
            </>
          )}
        </div>
      );
    }

    function App() {
      const [result, setResult] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [view, setView] = useState('query');
      const userId = 'user-' + Math.random().toString(36).substr(2, 9);

      useEffect(() => {
        console.log('App mounted, userId:', userId);
      }, []);

      const handleSubmit = async (input, isFollowUp) => {
        console.log('Submitting:', { input: typeof input === 'string' ? input : input.name, isFollowUp });
        setLoading(true);
        setError(null);
        try {
          if (typeof input === 'string') {
            const response = await fetch('http://localhost:3000/analyst-query', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ userId, question: input })
            });
            if (!response.ok) throw new Error(`Query failed: ${response.statusText}`);
            const data = await response.json();
            console.log('Query response:', data);
            setResult(data);
          } else {
            const formData = new FormData();
            formData.append('file', input);
            formData.append('userId', userId);
            const response = await fetch('http://localhost:3000/analyze-data', {
              method: 'POST',
              body: formData
            });
            if (!response.ok) throw new Error(`Data analysis failed: ${response.statusText}`);
            const data = await response.json();
            console.log('Data analysis response:', data);
            setResult(data);
          }
        } catch (err) {
          console.error('Fetch error:', err);
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };

      return (
        <ErrorBoundary>
          <div className="flex">
            <Sidebar
              onQuerySelect={() => setView('query')}
              onUploadSelect={() => setView('upload')}
            />
            <div className="flex-1 p-6">
              <div className="flex justify-end mb-4">
                <ThemeToggle />
              </div>
              <div className="max-w-4xl mx-auto">
                {view === 'query' && <AnalystQueryInput onSubmit={handleSubmit} />}
                {view === 'upload' && <DataUpload onSubmit={handleSubmit} />}
                <ResultDisplay
                  result={result}
                  loading={loading}
                  error={error}
                  onFollowUp={handleSubmit}
                />
              </div>
            </div>
          </div>
        </ErrorBoundary>
      );
    }

    try {
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
      console.log('React app rendered');
    } catch (e) {
      console.error('Rendering error:', e);
      document.getElementById('root').innerHTML = `
        <div style="color: #FF007A; text-align: center;">
          <h2>System Failure</h2>
          <p>${e.message}</p>
          <p>Check console for details.</p>
        </div>
      `;
    }
  </script>
</body>
</html>